<nav class="fixed w-full bg-bg dark:bg-bg shadow-md z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <!-- Logo -->
      <div class="flex items-center">
        <a href="{{ .Site.Home.RelPermalink }}"
           class="text-3xl font-bold text-text-primary dark:text-text-primary font-heading">
          {{ .Site.Params.name }}
        </a>
      </div>

      <!-- Desktop navigation -->
      <div class="hidden lg:flex items-center space-x-8">
        {{ range .Site.Menus.main }}
          {{ if .HasChildren }}
          <div class="relative group">
            <a href="{{ .URL | relLangURL }}"
               class="nav-link text-text-primary dark:text-text-primary flex items-center">
              {{ .Pre | safeHTML }}{{ .Name }}
              <i class="fas fa-chevron-down ml-2 text-sm"></i>
            </a>
            <div
              class="submenu absolute left-0 top-full mt-2 bg-bg dark:bg-bg shadow-lg rounded-lg z-50 min-w-[10rem] opacity-0 invisible">
              {{ range .Children }}
                <a href="{{ .URL | relLangURL }}"
                   class="nav-link block px-4 py-2 text-sm text-text-primary dark:text-text-primary">
                  {{ .Name }}
                </a>
              {{ end }}
            </div>
          </div>
          {{ else }}
            {{ if hasPrefix .URL "#" }}
            <a href="{{ printf "%s%s" $.Site.Home.RelPermalink .URL }}"
               class="nav-link section-link text-text-primary dark:text-text-primary"
               data-section="{{ .URL }}">
              {{ .Name }}
            </a>
            {{ else }}
            <a href="{{ .URL | relLangURL }}"
               class="nav-link text-text-primary dark:text-text-primary">
              {{ .Name }}
            </a>
            {{ end }}
          {{ end }}
        {{ end }}

        <!-- Language switcher -->
        {{ $homes := $.Site.Home.AllTranslations }}
        {{ if gt (len $homes) 1 }}
        {{ $cur := $.Site.Language.Lang }}
        {{ $currentFlag := "üè≥Ô∏è" }}
        {{ if eq $cur "en" }}{{ $currentFlag = "üá¨üáß" }}{{ end }}
        {{ if eq $cur "es" }}{{ $currentFlag = "üá®üá±" }}{{ end }}
        {{ if eq $cur "fr" }}{{ $currentFlag = "üá´üá∑" }}{{ end }}

        <div class="relative group">
          <a href="#"
             class="nav-link text-text-primary dark:text-text-primary flex items-center"
             aria-label="Language switcher">
            <span class="text-lg mr-1">{{ $currentFlag }}</span>
            <i class="fas fa-chevron-down ml-1 text-sm"></i>
          </a>
          <div
            class="submenu absolute right-0 top-full mt-2 bg-bg dark:bg-bg shadow-lg rounded-lg z-50 min-w-[8rem] opacity-0 invisible">
            {{ range $homes }}
            <a href="{{ .RelPermalink }}"
               class="nav-link block px-4 py-2 text-sm text-text-primary dark:text-text-primary {{ if eq .Language.Lang $.Site.Language.Lang }}font-semibold{{ end }}">
              {{ .Language.LanguageName }}
            </a>
            {{ end }}
          </div>
        </div>
        {{ end }}

        <!-- Social icons -->
        <div class="flex items-center space-x-4" data-animation="social">
          {{ if .Site.Params.linkedin_url }}
          <a href="{{ .Site.Params.linkedin_url }}" target="_blank" rel="noopener noreferrer"
             class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
            <i class="fab fa-linkedin-in text-xl"></i>
          </a>
          {{ end }}
          {{ if .Site.Params.github_url }}
          <a href="{{ .Site.Params.github_url }}" target="_blank" rel="noopener noreferrer"
             class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
            <i class="fab fa-github text-xl"></i>
          </a>
          {{ end }}
        </div>
      </div>

      <!-- Mobile menu button -->
      <div class="lg:hidden flex items-center">
        <button id="menu-btn" 
                type="button"
                class="text-text-primary dark:text-text-primary p-2 focus:outline-none"
                aria-label="Toggle menu"
                aria-expanded="false"
                style="touch-action: manipulation; -webkit-tap-highlight-color: transparent;">
          <i class="fas fa-bars text-2xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" 
       class="hidden lg:hidden bg-bg dark:bg-bg shadow-lg"
       style="touch-action: manipulation;">
    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
      {{ range .Site.Menus.main }}
        {{ if hasPrefix .URL "#" }}
          <a href="{{ printf "%s%s" $.Site.Home.RelPermalink .URL }}"
             class="nav-link section-link block px-3 py-2 rounded-md text-base font-medium text-text-primary dark:text-text-primary"
             data-section="{{ .URL }}">
            {{ .Name }}
          </a>
        {{ else }}
          <a href="{{ .URL | relLangURL }}"
             class="nav-link block px-3 py-2 rounded-md text-base font-medium text-text-primary dark:text-text-primary">
            {{ .Name }}
          </a>
        {{ end }}
        {{ if .HasChildren }}
          {{ range .Children }}
            <a href="{{ .URL | relLangURL }}" class="block pl-6 py-1 text-sm text-text-tertiary dark:text-text-tertiary">{{ .Name }}</a>
          {{ end }}
        {{ end }}
      {{ end }}
    </div>
  </div>

  <!-- Prevent zoom on double-tap -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Submenu styles -->
  <style>
    .group.open .submenu {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* Prevent iOS zoom on tap */
    button, a {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    
    /* Ensure mobile menu is above everything */
    #mobile-menu {
      position: relative;
      z-index: 10000;
    }
  </style>

  <!-- Navigation JS - ERROR PROOF -->
  <script>
    (function() {
      'use strict';
      
      // Prevent this script from running multiple times
      if (window.__navInitialized) {
        console.log('Navigation already initialized, skipping');
        return;
      }
      
      console.log('üöÄ Navigation initialization starting...');
      
      function initNavigation() {
        try {
          // Get elements
          const menuBtn = document.getElementById('menu-btn');
          const mobileMenu = document.getElementById('mobile-menu');
          
          if (!menuBtn || !mobileMenu) {
            console.error('Navigation elements not found:', {menuBtn, mobileMenu});
            return;
          }
          
          console.log('‚úÖ Navigation elements found');
          
          // Mobile menu toggle - CRITICAL: Prevent default and stop propagation
          menuBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log('Menu button clicked');
            
            try {
              const wasHidden = mobileMenu.classList.contains('hidden');
              mobileMenu.classList.toggle('hidden');
              menuBtn.setAttribute('aria-expanded', wasHidden ? 'true' : 'false');
              
              console.log('Menu toggled:', wasHidden ? 'opened' : 'closed');
            } catch (err) {
              console.error('Error toggling menu:', err);
            }
            
            return false;
          }, {passive: false, capture: true});
          
          // Prevent any touch/click events from bubbling
          menuBtn.addEventListener('touchstart', function(e) {
            e.stopPropagation();
          }, {passive: true});
          
          menuBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            e.stopPropagation();
          }, {passive: false});
          
          console.log('‚úÖ Menu button listeners attached');
          
          // Desktop submenu toggle
          try {
            document.querySelectorAll('.group > a.nav-link').forEach(link => {
              link.addEventListener('click', function (e) {
                e.preventDefault();
                const group = this.closest('.group');
                const isOpen = group.classList.contains('open');

                document.querySelectorAll('.group').forEach(g => g.classList.remove('open'));
                if (!isOpen) group.classList.add('open');
              });
            });
            
            console.log('‚úÖ Desktop submenu initialized');
          } catch (err) {
            console.error('Error initializing desktop submenu:', err);
          }

          // Close submenus when clicking outside
          try {
            document.addEventListener('click', function (event) {
              document.querySelectorAll('.group').forEach(group => {
                if (!group.contains(event.target)) {
                  group.classList.remove('open');
                }
              });
            });
          } catch (err) {
            console.error('Error setting up outside click handler:', err);
          }

          // Close mobile menu when clicking menu items
          try {
            document.querySelectorAll('#mobile-menu a').forEach(link => {
              link.addEventListener('click', function () {
                console.log('Menu link clicked, closing menu');
                mobileMenu.classList.add('hidden');
                menuBtn.setAttribute('aria-expanded', 'false');
              });
            });
            
            console.log('‚úÖ Menu close on click initialized');
          } catch (err) {
            console.error('Error setting up menu close:', err);
          }

          // Intelligent section navigation
          try {
            document.querySelectorAll('.section-link').forEach(link => {
              link.addEventListener('click', function (e) {
                e.preventDefault();
                const section = this.dataset.section;
                const home = '{{ .Site.Home.RelPermalink }}';

                if (window.location.pathname === home || window.location.pathname === home + 'index.html') {
                  const el = document.querySelector(section);
                  if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                  }
                } else {
                  window.location.href = home + section;
                }
              });
            });
            
            console.log('‚úÖ Section navigation initialized');
          } catch (err) {
            console.error('Error setting up section navigation:', err);
          }
          
          window.__navInitialized = true;
          console.log('‚úÖ Navigation fully initialized');
          
        } catch (error) {
          console.error('Fatal error in navigation initialization:', error);
        }
      }
      
      // Initialize with multiple fallbacks
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNavigation);
      } else {
        initNavigation();
      }
      
      // Backup initialization
      setTimeout(initNavigation, 1000);
      
    })();
  </script>
</nav>
