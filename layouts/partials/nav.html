<nav class="fixed w-full bg-bg dark:bg-bg shadow-md z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between h-16">
      <!-- Logo -->
      <div class="flex items-center">
        <a href="{{ .Site.Home.RelPermalink }}"
           class="text-3xl font-bold text-text-primary dark:text-text-primary font-heading">
          {{ .Site.Params.name }}
        </a>
      </div>

      <!-- Desktop navigation -->
      <div class="hidden lg:flex items-center space-x-8">
        {{ range .Site.Menus.main }}
          {{ if .HasChildren }}
          <div class="relative group">
            <a href="{{ .URL | relLangURL }}"
               class="nav-link text-text-primary dark:text-text-primary flex items-center">
              {{ .Pre | safeHTML }}{{ .Name }}
              <i class="fas fa-chevron-down ml-2 text-sm"></i>
            </a>
            <div
              class="submenu absolute left-0 top-full mt-2 bg-bg dark:bg-bg shadow-lg rounded-lg z-50 min-w-[10rem] opacity-0 invisible">
              {{ range .Children }}
                <a href="{{ .URL | relLangURL }}"
                   class="nav-link block px-4 py-2 text-sm text-text-primary dark:text-text-primary">
                  {{ .Name }}
                </a>
              {{ end }}
            </div>
          </div>
          {{ else }}
            {{ if hasPrefix .URL "#" }}
            <a href="{{ printf "%s%s" $.Site.Home.RelPermalink .URL }}"
               class="nav-link section-link text-text-primary dark:text-text-primary"
               data-section="{{ .URL }}">
              {{ .Name }}
            </a>
            {{ else }}
            <a href="{{ .URL | relLangURL }}"
               class="nav-link text-text-primary dark:text-text-primary">
              {{ .Name }}
            </a>
            {{ end }}
          {{ end }}
        {{ end }}

        <!-- Language switcher -->
        {{ $homes := $.Site.Home.AllTranslations }}
        {{ if gt (len $homes) 1 }}
        {{ $cur := $.Site.Language.Lang }}
        {{ $currentFlag := "üè≥Ô∏è" }}
        {{ if eq $cur "en" }}{{ $currentFlag = "üá¨üáß" }}{{ end }}
        {{ if eq $cur "es" }}{{ $currentFlag = "üá®üá±" }}{{ end }}
        {{ if eq $cur "fr" }}{{ $currentFlag = "üá´üá∑" }}{{ end }}

        <div class="relative group">
          <a href="#"
             class="nav-link text-text-primary dark:text-text-primary flex items-center"
             aria-label="Language switcher">
            <span class="text-lg mr-1">{{ $currentFlag }}</span>
            <i class="fas fa-chevron-down ml-1 text-sm"></i>
          </a>
          <div
            class="submenu absolute right-0 top-full mt-2 bg-bg dark:bg-bg shadow-lg rounded-lg z-50 min-w-[8rem] opacity-0 invisible">
            {{ range $homes }}
            <a href="{{ .RelPermalink }}"
               class="nav-link block px-4 py-2 text-sm text-text-primary dark:text-text-primary {{ if eq .Language.Lang $.Site.Language.Lang }}font-semibold{{ end }}">
              {{ .Language.LanguageName }}
            </a>
            {{ end }}
          </div>
        </div>
        {{ end }}

        <!-- Social icons -->
        <div class="flex items-center space-x-4" data-animation="social">
          {{ if .Site.Params.linkedin_url }}
          <a href="{{ .Site.Params.linkedin_url }}" target="_blank" rel="noopener noreferrer"
             class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
            <i class="fab fa-linkedin-in text-xl"></i>
          </a>
          {{ end }}
          {{ if .Site.Params.github_url }}
          <a href="{{ .Site.Params.github_url }}" target="_blank" rel="noopener noreferrer"
             class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
            <i class="fab fa-github text-xl"></i>
          </a>
          {{ end }}
        </div>
      </div>

      <!-- Mobile menu button -->
      <div class="lg:hidden flex items-center">
        <button id="menu-btn" 
                class="text-text-primary dark:text-text-primary p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary"
                aria-label="Toggle menu"
                aria-expanded="false">
          <i id="menu-icon" class="fas fa-bars text-2xl"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" 
       class="hidden lg:hidden bg-bg dark:bg-bg shadow-lg border-t border-gray-200 dark:border-gray-700"
       style="position: relative; z-index: 9999;">
    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
      {{ range .Site.Menus.main }}
        {{ if hasPrefix .URL "#" }}
        <a href="{{ printf "%s%s" $.Site.Home.RelPermalink .URL }}"
           class="mobile-nav-link section-link block px-3 py-2 rounded-md text-base font-medium text-text-primary dark:text-text-primary hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
           data-section="{{ .URL }}">
          {{ .Name }}
        </a>
        {{ else }}
        <a href="{{ .URL | relLangURL }}"
           class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-primary dark:text-text-primary hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
          {{ .Name }}
        </a>
        {{ end }}
      {{ end }}
      
      <!-- Mobile social icons -->
      <div class="flex items-center space-x-6 px-3 py-4 border-t border-gray-200 dark:border-gray-700 mt-2">
        {{ if .Site.Params.linkedin_url }}
        <a href="{{ .Site.Params.linkedin_url }}" target="_blank" rel="noopener noreferrer"
           class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
          <i class="fab fa-linkedin-in text-2xl"></i>
        </a>
        {{ end }}
        {{ if .Site.Params.github_url }}
        <a href="{{ .Site.Params.github_url }}" target="_blank" rel="noopener noreferrer"
           class="text-text-primary dark:text-text-primary transition-transform duration-300 hover:scale-125">
          <i class="fab fa-github text-2xl"></i>
        </a>
        {{ end }}
      </div>
    </div>
  </div>

  <!-- Submenu styles -->
  <style>
    .group.open .submenu {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* Ensure mobile menu appears above everything */
    #mobile-menu {
      position: relative;
      z-index: 9999 !important;
    }
    
    /* Smooth transitions */
    #mobile-menu {
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }
    
    #mobile-menu:not(.hidden) {
      max-height: 500px;
      opacity: 1;
    }
  </style>

  <!-- Navigation JS -->
  <script>
    (function() {
      console.log('Navigation script initializing...');
      
      // Desktop submenu toggle
      document.querySelectorAll('.group > a.nav-link').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const group = this.closest('.group');
          const isOpen = group.classList.contains('open');

          document.querySelectorAll('.group').forEach(g => g.classList.remove('open'));
          if (!isOpen) group.classList.add('open');
        });
      });

      // Close submenus when clicking outside
      document.addEventListener('click', function (event) {
        document.querySelectorAll('.group').forEach(group => {
          if (!group.contains(event.target)) {
            group.classList.remove('open');
          }
        });
      });

      // Mobile menu toggle
      const menuBtn = document.getElementById('menu-btn');
      const mobileMenu = document.getElementById('mobile-menu');
      const menuIcon = document.getElementById('menu-icon');
      
      console.log('Menu button:', menuBtn);
      console.log('Mobile menu:', mobileMenu);
      console.log('Menu icon:', menuIcon);
      
      if (!menuBtn || !mobileMenu || !menuIcon) {
        console.error('Mobile menu elements not found!');
        return;
      }

      function toggleMobileMenu() {
        const isHidden = mobileMenu.classList.contains('hidden');
        console.log('Toggle called, currently hidden:', isHidden);
        
        mobileMenu.classList.toggle('hidden');
        
        // Update aria-expanded
        menuBtn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        
        // Toggle icon between hamburger and close
        if (isHidden) {
          menuIcon.classList.remove('fa-bars');
          menuIcon.classList.add('fa-times');
          console.log('Menu opened, icon changed to X');
        } else {
          menuIcon.classList.remove('fa-times');
          menuIcon.classList.add('fa-bars');
          console.log('Menu closed, icon changed to hamburger');
        }
      }

      menuBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('Menu button clicked');
        toggleMobileMenu();
      });

      // Close mobile menu when clicking a link
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
      console.log('Mobile nav links found:', mobileNavLinks.length);
      
      mobileNavLinks.forEach(link => {
        link.addEventListener('click', function() {
          console.log('Mobile nav link clicked, closing menu');
          if (!mobileMenu.classList.contains('hidden')) {
            toggleMobileMenu();
          }
        });
      });

      // Close menu when clicking outside
      document.addEventListener('click', function(event) {
        if (!menuBtn.contains(event.target) && 
            !mobileMenu.contains(event.target) && 
            !mobileMenu.classList.contains('hidden')) {
          console.log('Clicked outside, closing menu');
          toggleMobileMenu();
        }
      });

      // Intelligent section navigation
      document.querySelectorAll('.section-link').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const section = this.dataset.section;
          const home = '{{ .Site.Home.RelPermalink }}';

          console.log('Section link clicked:', section);

          if (window.location.pathname === home || window.location.pathname === home + 'index.html') {
            const el = document.querySelector(section);
            if (el) {
              el.scrollIntoView({ behavior: 'smooth', block: 'start' });
              console.log('Scrolled to section:', section);
            }
          } else {
            window.location.href = home + section;
          }
        });
      });
      
      console.log('Navigation script initialized successfully');
    })();
  </script>
</nav>
