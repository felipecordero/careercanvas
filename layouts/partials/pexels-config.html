{{/* 
Pexels API Configuration
This partial provides the API key, queries, and default image to the frontend JavaScript.
SECURITY NOTE: 
- API key is fetched securely at runtime from a serverless function
- No sensitive data is exposed in the HTML source
- Queries are safe to expose as they're just search terms
*/}}

{{/* Set Pexels queries from Hugo config (safe to expose) */}}
{{ $pexelsQueries := .Site.Params.pexels.queries }}
{{ if not $pexelsQueries }}
  {{ errorf "Pexels queries not configured in config.toml under [params.pexels.queries]" }}
{{ end }}

{{/* Set default hero image from Hugo config */}}
{{ $defaultHeroImage := .Site.Params.default_hero_image | default "/images/hero-default-bg.jpg" }}

<div id="pexels-config" 
     data-queries="{{ $pexelsQueries | jsonify }}" 
     data-default-image="{{ $defaultHeroImage }}"
     style="display: none;">
</div>

<script>
  // Initialize configuration - API key will be fetched at runtime
  window.PEXELS_API_KEY = null; // Will be set by fetchConfig()
  
  // Load queries from data attribute (configured in config.toml)
  const configElement = document.getElementById('pexels-config');
  if (configElement) {
    try {
      window.PEXELS_QUERIES = JSON.parse(configElement.getAttribute('data-queries'));
    } catch (error) {
      console.error('Error parsing Pexels queries from config.toml:', error);
      // No fallback - queries must be configured in config.toml
      window.PEXELS_QUERIES = [];
    }
    
    // Load default hero image from data attribute
    window.DEFAULT_HERO_IMAGE = configElement.getAttribute('data-default-image');
    console.log('Default hero image configured:', window.DEFAULT_HERO_IMAGE);
  } else {
    console.error('Pexels config element not found');
    window.PEXELS_QUERIES = [];
    window.DEFAULT_HERO_IMAGE = '/images/hero-default-bg.jpg'; // Fallback
  }

  // Function to fetch secure configuration at runtime
  async function fetchConfig() {
    try {
      // Use local development server if running on localhost
      const apiUrl = window.location.hostname === 'localhost' 
        ? 'http://localhost:3001/api/config' 
        : '/api/config';
        
      const response = await fetch(apiUrl);
      if (response.ok) {
        const config = await response.json();
        window.PEXELS_API_KEY = config.pexelsApiKey;
        window.FORMSPREE_ENDPOINT = config.formspreeEndpoint;
        console.log('Configuration loaded securely');
      } else {
        console.warn('Failed to load configuration from API, will use default image');
        // Don't set PEXELS_API_KEY, let the background script use default image
      }
    } catch (error) {
      console.warn('Error loading configuration:', error, '- will use default image');
      // Don't set PEXELS_API_KEY, let the background script use default image
    }
  }

  // Load configuration when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchConfig);
  } else {
    fetchConfig();
  }
</script>
